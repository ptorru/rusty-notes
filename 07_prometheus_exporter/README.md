# Deploying a Prometheus Exporter
This is just a quick test run of the [*prometheus_exporter*](https://crates.io/crates/prometheus_exporter) crate by [Alexander Thaller](https://github.com/AlexanderThaller).

The ultimate goal is to plot data into a Grafana dashboard.

This crate is a real time saver. You can use their examples as a fully working template.

I had a couple of issues getting the dependencies right, you may find this working repo useful for that.

## Compilation
Just compile via the usual
```bash
cargo run
```

This should give you an exporter in [http://localhost:9186/metrics](http://localhost:9186/metrics). In your favorite web-browser that should look like this:
```
# HELP prometheus_exporter_request_duration_seconds The HTTP request latencies in seconds.
# TYPE prometheus_exporter_request_duration_seconds histogram
prometheus_exporter_request_duration_seconds_bucket{le="0.005"} 3148
prometheus_exporter_request_duration_seconds_bucket{le="0.01"} 3148
prometheus_exporter_request_duration_seconds_bucket{le="0.025"} 3148
prometheus_exporter_request_duration_seconds_bucket{le="0.05"} 3148
prometheus_exporter_request_duration_seconds_bucket{le="0.1"} 3148
prometheus_exporter_request_duration_seconds_bucket{le="0.25"} 3148
prometheus_exporter_request_duration_seconds_bucket{le="0.5"} 3148
prometheus_exporter_request_duration_seconds_bucket{le="1"} 3148
prometheus_exporter_request_duration_seconds_bucket{le="2.5"} 3148
prometheus_exporter_request_duration_seconds_bucket{le="5"} 3148
prometheus_exporter_request_duration_seconds_bucket{le="10"} 3148
prometheus_exporter_request_duration_seconds_bucket{le="+Inf"} 3148
prometheus_exporter_request_duration_seconds_sum 0.013808427999999963
prometheus_exporter_request_duration_seconds_count 3148
# HELP prometheus_exporter_requests_total Number of HTTP requests received.
# TYPE prometheus_exporter_requests_total counter
prometheus_exporter_requests_total 3148
# HELP prometheus_exporter_response_size_bytes The HTTP response sizes in bytes.
# TYPE prometheus_exporter_response_size_bytes gauge
prometheus_exporter_response_size_bytes 1560
# HELP run_and_repeat_random will set a random value
# TYPE run_and_repeat_random gauge
run_and_repeat_random 0.6459195739828202
```

# Get yourself an instance of Prometheus
In your local machine [or another one] with docker available, you can very easily get a prometheus instance:

```bash
# Stop: consider also using the binaries, see the references
# Note: please note the use of the -v parameter. Run from this entry's root
docker run -d --name prometheus-container -e TZ=UTC -p 30090:9090 -v "$[pwd]"/prometheus:/etc/prometheus ubuntu/prometheus:2.25-21.04_beta
```

Notice that I am usign the -v parameter. In there we are binding the local prometheus folder that contains the prometheus configuration file. If using a remote machine you will have to replace localhost with the appropriate ip-address.

You should now get a Prometheus web server at [http://localhost:30090](http://localhost:30090).

# Get yourself an instance of Grafana
Likewise with Docker:
```bash
docker run -d --name=grafana -p 3000:3000 grafana/grafana
```

You should now get a Grafana web server at [http://localhost:3000](http://localhost:3000).

# Set up a dashboard
I am being a bit light on directions here, but try to create a new panel in grafana. You will get to a space asking for a [PromQL](https://www.infracloud.io/blogs/promql-prometheus-guide/) entry.

You can get it from the Prometheus server, by searching for *run_and_repeat_random* in the [Table page](http://localhost:30090/graph?g0.expr=&g0.tab=1&g0.stacked=0&g0.range_input=1h) [the link points to localhost].

You should see a string like the following.
```
run_and_repeat_random{instance="localhost:9186", job="prometheus"}
```
Add it into the Grafana PromQL query entry of the panel you are creating.

Soon after that you should be able to see the data being generated by the exporter.

# Extra Notes

## Reloading the Prometheus config
If needed to reload the config on the fly, follow these steps after changing the configuration file:
```bash
# get yourself a terminal in the container
docker exec -it prometheus-container /usr/bin/bash

# Get the prometheus process, changes are that it is 1, but double check!
ps -ef | grep prometheus

# Send a HUP [hang-up] signal to the process
kill -s HUB 1
```



# References
* [Eddie Zaneski - Setting up Prometheus and Grafana for monitoring your servers](https://youtu.be/4WWW2ZLEg74). This is a real time saver! Awesome step by step guide.
